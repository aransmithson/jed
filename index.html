<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DISPATCH 911</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&display=swap');
:root{
  --bg:#07111a;--panel:#060c12;--border:#1a3550;
  --accent:#00d4ff;--red:#ff3333;--amber:#ffaa00;
  --green:#00ff88;--police:#4499ff;--fire:#ff5500;--amb:#ff3399;--heli:#aa44ff;
  --text:#7aaccc;--bright:#cce8ff;--dim:#1a3a55;
}
*{margin:0;padding:0;box-sizing:border-box;touch-action:none;-webkit-tap-highlight-color:transparent;}
html,body{width:100vw;height:100vh;overflow:hidden;background:var(--bg);font-family:'Share Tech Mono',monospace;color:var(--text);}

#title{position:fixed;inset:0;background:#050b10;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9000;}
#title-bg{position:absolute;inset:0;background:radial-gradient(ellipse 80% 55% at 50% 38%,#0d2840 0%,#050b10 70%);overflow:hidden;}
.tgl{position:absolute;background:rgba(0,212,255,.03);}
#tc{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;gap:5px;text-align:center;padding:16px;}
.t-badge{font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:.4em;font-size:11px;color:var(--red);border:1px solid #ff333344;padding:3px 14px;margin-bottom:5px;animation:blink2 2s infinite;}
.t-main{font-family:'Bebas Neue',sans-serif;font-size:clamp(54px,13vw,96px);color:var(--accent);line-height:.85;letter-spacing:.05em;text-shadow:0 0 40px rgba(0,212,255,.5),0 0 80px rgba(0,212,255,.2);}
.t-sub{font-family:'Barlow Condensed',sans-serif;font-weight:300;letter-spacing:.3em;font-size:13px;color:var(--text);margin-top:3px;}
.t-icons{display:flex;gap:18px;margin:12px 0;font-size:34px;}
#explainer{background:rgba(0,0,0,.45);border:1px solid var(--border);border-radius:8px;padding:13px 16px;max-width:340px;width:90%;display:flex;flex-direction:column;gap:8px;margin:5px 0;}
.ex-row{display:flex;align-items:flex-start;gap:10px;}
.ex-n{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent);line-height:1;flex-shrink:0;width:17px;}
.ex-t{font-family:'Barlow Condensed',sans-serif;font-size:12px;color:var(--bright);line-height:1.4;}
.ex-t b{color:var(--accent);}
#start-btn{margin-top:12px;font-family:'Bebas Neue',sans-serif;font-size:25px;letter-spacing:.2em;color:#060c12;background:var(--accent);border:none;padding:10px 42px;border-radius:4px;cursor:pointer;box-shadow:0 0 26px rgba(0,212,255,.4);animation:btnp 2s 1s infinite;}
#start-btn:hover{transform:scale(1.04);}
@keyframes blink2{0%,100%{opacity:1}50%{opacity:.45}}
@keyframes btnp{0%,100%{box-shadow:0 0 26px rgba(0,212,255,.4)}50%{box-shadow:0 0 48px rgba(0,212,255,.7)}}

#game{display:none;flex-direction:column;width:100vw;height:100vh;}
#game.on{display:flex;}
/* Map takes remaining space after the bottom panel */
#map-wrap{flex:1 1 0;min-height:0;position:relative;overflow:hidden;}
#map-canvas{position:absolute;top:0;left:0;width:100%;height:100%;cursor:crosshair;}

/* Bottom panel: fixed height based on content, never more than 35vh */
#bot{flex:0 0 auto;max-height:35vh;background:var(--panel);border-top:2px solid var(--border);display:flex;flex-direction:column;position:relative;z-index:10;overflow:hidden;}

#ticker{display:flex;align-items:center;height:20px;flex-shrink:0;background:rgba(0,0,0,.4);border-bottom:1px solid var(--border);overflow:hidden;font-size:9px;padding:0 8px;gap:8px;}
#t-badge{background:var(--red);color:#fff;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:11px;padding:1px 7px;letter-spacing:.1em;flex-shrink:0;animation:blink2 .9s infinite;}
#t-inner{display:flex;gap:14px;white-space:nowrap;overflow:hidden;flex:1;}
.ti{display:flex;align-items:center;gap:5px;flex-shrink:0;}
.td{width:6px;height:6px;border-radius:50%;}

#sbar{display:flex;align-items:center;justify-content:space-around;padding:2px 8px;border-bottom:1px solid var(--border);background:rgba(0,0,0,.3);flex-shrink:0;gap:2px;}
.si{display:flex;flex-direction:column;align-items:center;}
.sl{font-size:6px;letter-spacing:.1em;color:var(--dim);text-transform:uppercase;}
.sv{font-family:'Bebas Neue',sans-serif;font-size:17px;line-height:1;}
.sv.g{color:var(--green);}.sv.b{color:var(--accent);}.sv.r{color:var(--amber);}.sv.w{color:var(--bright);}
#ra-el{font-size:17px;line-height:1;}
#mute-btn{
  background:rgba(0,212,255,.07);border:1px solid rgba(0,212,255,.28);
  border-radius:4px;color:var(--accent);font-size:13px;
  padding:2px 7px;cursor:pointer;flex-shrink:0;
  transition:opacity .2s,border-color .2s;
}
#mute-btn.muted{opacity:.4;border-color:var(--dim);}

#main-row{flex:1;display:flex;flex-direction:row;min-height:60px;overflow:hidden;}
#status-panel{flex:0 0 38%;border-right:1px solid var(--border);background:rgba(0,0,0,.2);display:flex;flex-direction:column;padding:4px 7px 3px;overflow:hidden;}
#sp-body{position:relative;flex:1;min-height:0;}
#sp-idle{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;opacity:.3;transition:opacity .15s;}
#sp-idle.hidden{opacity:0;pointer-events:none;}
#sp-idle-icon{font-size:18px;}
#sp-idle-txt{font-size:8px;letter-spacing:.06em;color:var(--text);text-align:center;line-height:1.4;}
#sp-active{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;padding:3px 0 2px;overflow:hidden;opacity:0;pointer-events:none;transition:opacity .15s;}
#sp-active.on{opacity:1;pointer-events:auto;}
#sp-title{font-family:'Bebas Neue',sans-serif;font-size:15px;color:var(--red);letter-spacing:.06em;line-height:1;flex-shrink:0;}
#sp-sev{font-size:7px;color:var(--amber);letter-spacing:.1em;flex-shrink:0;}
#sp-loc{font-size:7px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;}
#sp-desc{font-size:7px;color:var(--text);line-height:1.35;flex:1;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
#sp-needs{display:flex;flex-wrap:wrap;gap:3px;flex-shrink:0;}
.np{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:9px;padding:1px 5px;border-radius:2px;letter-spacing:.04em;}
.np.police{background:rgba(68,153,255,.14);color:var(--police);border:1px solid var(--police);}
.np.fire{background:rgba(255,85,0,.14);color:var(--fire);border:1px solid var(--fire);}
.np.amb{background:rgba(255,51,153,.14);color:var(--amb);border:1px solid var(--amb);}
.np.heli{background:rgba(170,68,255,.14);color:var(--heli);border:1px solid var(--heli);}
.np.done{opacity:.3;text-decoration:line-through;}
#sp-close{font-size:7px;color:var(--dim);cursor:pointer;letter-spacing:.05em;flex-shrink:0;text-align:right;}
#sp-close:hover{color:var(--text);}

#ustrip{flex:0 0 62%;display:flex;align-items:center;justify-content:center;gap:3px;padding:3px 4px;overflow:hidden;}
.uc{background:rgba(0,0,0,.5);border:1px solid var(--border);border-radius:5px;padding:3px 4px;display:flex;flex-direction:column;align-items:center;gap:0px;cursor:grab;user-select:none;transition:border-color .2s,box-shadow .2s;position:relative;flex:1;min-width:0;}
.uc.police{border-color:rgba(68,153,255,.35);}
.uc.fire{border-color:rgba(255,85,0,.35);}
.uc.amb{border-color:rgba(255,51,153,.35);}
.uc.heli{border-color:rgba(170,68,255,.35);}
.uc.busy{opacity:.38;cursor:not-allowed;}
.uc:not(.busy):hover{box-shadow:0 0 10px rgba(0,212,255,.18);}
.ui-big{font-size:17px;line-height:1.1;}
.ul{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:7px;letter-spacing:.04em;}
.ul.police{color:var(--police);}.ul.fire{color:var(--fire);}.ul.amb{color:var(--amb);}.ul.heli{color:var(--heli);}
.us{font-size:6px;}.us.ok{color:var(--green);}.us.on{color:var(--amber);}
.uc-cnt{position:absolute;top:1px;right:2px;background:var(--accent);color:#060c12;font-size:6px;font-weight:bold;width:10px;height:10px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
#upg-btn{background:rgba(0,212,255,.07);border:1px solid rgba(0,212,255,.35);border-radius:5px;color:var(--accent);font-family:'Barlow Condensed',sans-serif;font-weight:700;padding:3px 4px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:0px;flex:1;min-width:0;transition:border-color .2s,box-shadow .2s;}
#upg-btn:hover{box-shadow:0 0 10px rgba(0,212,255,.25);border-color:var(--accent);}
#upg-icon{font-size:15px;line-height:1.1;}
#upg-label{font-size:6px;letter-spacing:.04em;}

#ghost{position:fixed;pointer-events:none;z-index:9999;font-size:28px;transform:translate(-50%,-50%);display:none;}

/* â”€â”€ UPGRADE MODAL â”€â”€ */
#um{display:none;position:fixed;inset:0;background:rgba(0,0,0,.87);z-index:600;align-items:center;justify-content:center;}
#um.on{display:flex;}
.mb{
  background:var(--panel);border:1px solid var(--accent);border-radius:10px;
  padding:12px 12px 14px;width:min(420px,96vw);max-height:96vh;
  display:flex;flex-direction:column;gap:8px;overflow:hidden;
}
.mb-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;flex-shrink:0;}
.mt{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent);letter-spacing:.15em;line-height:1;}
.mt-sub{font-size:7px;color:var(--dim);letter-spacing:.1em;margin-top:1px;}
#um-close{
  background:transparent;border:1px solid var(--border);color:var(--text);
  font-size:14px;line-height:1;width:26px;height:26px;
  border-radius:5px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;
  transition:border-color .15s,color .15s;
}
#um-close:hover{border-color:var(--accent);color:var(--accent);}

/* Upgrade tile grid â€” 5 columns, all tiers in one view */
#ul2{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;align-items:start;}
.utile{
  background:rgba(0,0,0,.5);border:1px solid var(--border);border-radius:6px;
  padding:7px 3px 6px;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;gap:2px;
  transition:border-color .18s,background .18s;position:relative;
  justify-content:center;
}
.utile:hover:not(.bought):not(.cant-afford){border-color:var(--accent);background:rgba(0,212,255,.06);}
.utile.bought{opacity:.32;cursor:default;}
.utile.cant-afford{cursor:not-allowed;}
.tier-row{
  grid-column:1/-1;
  display:flex;align-items:center;gap:6px;
  margin-top:2px;
}
.tier-label{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:9px;letter-spacing:.1em;white-space:nowrap;}
.tier-line{flex:1;height:1px;background:currentColor;opacity:.22;}
.utile-icon{font-size:18px;line-height:1;}
.utile-name{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:8px;color:var(--bright);text-align:center;line-height:1.2;}
.utile-price{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:10px;color:var(--green);}
.utile-price.cant{color:var(--amber);}
.utile-price.owned{color:var(--green);font-size:8px;letter-spacing:.04em;}
.utile-check{position:absolute;top:3px;right:4px;font-size:9px;color:var(--green);}

body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,212,255,.012) 0,rgba(0,212,255,.012) 1px,transparent 1px,transparent 3px);pointer-events:none;z-index:8000;}

/* â”€â”€ GAME OVER â”€â”€ */
#go-screen{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.92);
  z-index:7000;align-items:center;justify-content:center;
}
#go-screen.on{display:flex;}
#go-box{
  background:var(--panel);border:2px solid var(--red);border-radius:12px;
  padding:28px 32px;width:min(340px,88vw);
  display:flex;flex-direction:column;align-items:center;gap:10px;
  animation:goIn .4s ease;
}
@keyframes goIn{from{opacity:0;transform:scale(.85)}to{opacity:1;transform:scale(1)}}
#go-face{font-size:56px;line-height:1;animation:shake .5s ease .2s;}
@keyframes shake{0%,100%{transform:rotate(0)}25%{transform:rotate(-8deg)}75%{transform:rotate(8deg)}}
#go-title{
  font-family:'Bebas Neue',sans-serif;font-size:32px;color:var(--red);
  letter-spacing:.12em;line-height:1;
  text-shadow:0 0 20px rgba(255,51,51,.6);
}
#go-sub{font-family:'Barlow Condensed',sans-serif;font-weight:400;font-size:11px;letter-spacing:.18em;color:var(--amber);text-transform:uppercase;margin-top:-4px;}
#go-stats{display:flex;gap:24px;margin:8px 0;}
.go-stat{display:flex;flex-direction:column;align-items:center;gap:2px;}
.go-sl{font-size:8px;letter-spacing:.12em;color:var(--dim);text-transform:uppercase;}
.go-sv{font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--bright);}
#go-btn{
  margin-top:6px;font-family:'Bebas Neue',sans-serif;font-size:22px;
  letter-spacing:.18em;color:#060c12;background:var(--red);
  border:none;padding:9px 36px;border-radius:4px;cursor:pointer;
  box-shadow:0 0 20px rgba(255,51,51,.4);
  transition:transform .15s,box-shadow .15s;
}
#go-btn:hover{transform:scale(1.05);box-shadow:0 0 32px rgba(255,51,51,.6);}
</style>
</head>
<body>

<div id="title">
  <div id="title-bg"></div>
  <div id="tc">
    <div class="t-badge">EMERGENCY RESPONSE SIMULATOR</div>
    <div class="t-main">DISPATCH<br>911</div>
    <div class="t-sub">PROTECT Â· RESPOND Â· RESOLVE</div>
    <div class="t-icons">ğŸš”&nbsp;ğŸš’&nbsp;ğŸš‘&nbsp;ğŸš</div>
    <div id="explainer">
      <div class="ex-row"><div class="ex-n">1</div><div class="ex-t"><b>Emergencies</b> flash on the city map. Tap one to see what services are needed.</div></div>
      <div class="ex-row"><div class="ex-n">2</div><div class="ex-t"><b>Drag a unit</b> from the panel onto the map, or select an incident then drag.</div></div>
      <div class="ex-row"><div class="ex-n">3</div><div class="ex-t">Ambulances drive to <b>hospital</b> after the scene before returning to base.</div></div>
      <div class="ex-row"><div class="ex-n">4</div><div class="ex-t">Keep your <b>rating face</b> happy â€” earn cash, buy upgrades, handle more calls.</div></div>
    </div>
    <button id="start-btn">RESPOND NOW</button>
  </div>
</div>

<div id="game">
  <div id="map-wrap">
    <canvas id="map-canvas"></canvas>
  </div>
  <div id="bot">
    <div id="ticker">
      <div id="t-badge">LIVE</div>
      <div id="t-inner">Monitoring city systems...</div>
    </div>
    <div id="sbar">
      <div class="si"><div class="sl">Score</div><div class="sv b" id="sc-el">0</div></div>
      <div class="si"><div class="sl">Funds</div><div class="sv g" id="mo-el">$0</div></div>
      <div class="si"><div class="sl">Rating</div><div id="ra-el">ğŸ˜„</div></div>
      <div class="si"><div class="sl">Resolved</div><div class="sv w" id="re-el">0</div></div>
      <div class="si"><div class="sl">Wave</div><div class="sv r" id="wa-el">1</div></div>
      <button id="mute-btn" title="Toggle sound">ğŸ”Š</button>
    </div>
    <div id="main-row">
      <div id="status-panel">
        <div id="sp-body">
          <div id="sp-idle"><div id="sp-idle-icon">ğŸ“¡</div><div id="sp-idle-txt">Tap an emergency on the map</div></div>
          <div id="sp-active">
            <div id="sp-title"></div>
            <div id="sp-sev"></div>
            <div id="sp-loc"></div>
            <div id="sp-desc"></div>
            <div id="sp-needs"></div>
            <div id="sp-close">âœ• CLEAR</div>
          </div>
        </div>
      </div>
      <div id="ustrip">
        <div class="uc police" id="uc-police"><div class="uc-cnt" id="cn-police">1</div><div class="ui-big">ğŸš”</div><div class="ul police">POLICE</div><div class="us ok" id="st-police">READY</div></div>
        <div class="uc fire"   id="uc-fire">  <div class="uc-cnt" id="cn-fire">1</div>  <div class="ui-big">ğŸš’</div><div class="ul fire">FIRE</div>    <div class="us ok" id="st-fire">READY</div></div>
        <div class="uc amb"    id="uc-amb">   <div class="uc-cnt" id="cn-amb">1</div>   <div class="ui-big">ğŸš‘</div><div class="ul amb">MEDIC</div>   <div class="us ok" id="st-amb">READY</div></div>
        <div class="uc heli"   id="uc-heli">  <div class="uc-cnt" id="cn-heli">1</div>  <div class="ui-big">ğŸš</div><div class="ul heli">HELI</div>    <div class="us ok" id="st-heli">READY</div></div>
        <button id="upg-btn"><div id="upg-icon">â¬†</div><div id="upg-label">UPGRADES</div></button>
      </div>
    </div>
  </div>
</div>

<div id="ghost"></div>

<!-- GAME OVER SCREEN -->
<div id="go-screen">
  <div id="go-box">
    <div id="go-face">ğŸ˜¡</div>
    <div id="go-title">CITY IN CRISIS</div>
    <div id="go-sub">PUBLIC CONFIDENCE COLLAPSED</div>
    <div id="go-stats">
      <div class="go-stat"><span class="go-sl">SCORE</span><span class="go-sv" id="go-score">0</span></div>
      <div class="go-stat"><span class="go-sl">RESOLVED</span><span class="go-sv" id="go-res">0</span></div>
      <div class="go-stat"><span class="go-sl">WAVE</span><span class="go-sv" id="go-wave">1</span></div>
    </div>
    <button id="go-btn">TRY AGAIN</button>
  </div>
</div>

<div id="um">
  <div class="mb">
    <div class="mb-header">
      <div><div class="mt">UPGRADE CENTER</div><div class="mt-sub">TAP TILE TO PURCHASE</div></div>
      <button id="um-close">âœ•</button>
    </div>
    <div id="ul2"></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  AUDIO  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let AC=null, MUTED=false;
function ensureAC(){if(!AC)AC=new(window.AudioContext||window.webkitAudioContext)();if(AC.state==='suspended')AC.resume();}
function tone(f,type,dur,vol=0.14,delay=0){
  if(MUTED||!AC)return;
  const o=AC.createOscillator(),g=AC.createGain();
  o.connect(g);g.connect(AC.destination);
  o.type=type;o.frequency.setValueAtTime(f,AC.currentTime+delay);
  g.gain.setValueAtTime(0,AC.currentTime+delay);
  g.gain.linearRampToValueAtTime(vol,AC.currentTime+delay+0.02);
  g.gain.exponentialRampToValueAtTime(0.001,AC.currentTime+delay+dur);
  o.start(AC.currentTime+delay);o.stop(AC.currentTime+delay+dur+0.05);
}
function sfxAlert(){tone(880,'sine',.12,.16);tone(660,'sine',.12,.12,.13);tone(880,'sine',.12,.14,.26);}
function sfxDispatch(){tone(440,'square',.07,.10);tone(550,'square',.07,.09,.08);tone(660,'square',.1,.10,.16);}
function sfxResolve(){[523,659,784,1047].forEach((f,i)=>tone(f,'sine',.2,.12,i*.08));}
function sfxTimeout(){tone(200,'sawtooth',.28,.14);tone(150,'sawtooth',.38,.11,.2);}
function sfxSiren(t){const f=t==='police'?880:t==='fire'?700:t==='heli'?550:620;[0,1,2].forEach(i=>{tone(f,'sine',.1,.07,i*.13);tone(f*.8,'sine',.1,.06,i*.13+.065);});}

document.getElementById('mute-btn').addEventListener('click',()=>{
  MUTED=!MUTED;
  const b=document.getElementById('mute-btn');
  b.textContent=MUTED?'ğŸ”‡':'ğŸ”Š';
  b.classList.toggle('muted',MUTED);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  MAP GRID  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   11 cols Ã— 8 rows â€” 12 vertical lines, 9 horizontal lines
*/
const CX=[0,.09,.18,.27,.36,.45,.54,.63,.72,.81,.90,1.0];
const RY=[0,.125,.25,.375,.50,.625,.75,.875,1.0];

function nid(col,row){return row*12+col;}
const NODES=[];
for(let r=0;r<9;r++) for(let c=0;c<12;c++) NODES.push({id:nid(c,r),x:CX[c],y:RY[r]});
const EDGES=[];
for(let r=0;r<9;r++) for(let c=0;c<11;c++) EDGES.push([nid(c,r),nid(c+1,r)]);
for(let r=0;r<8;r++) for(let c=0;c<12;c++) EDGES.push([nid(c,r),nid(c,r+1)]);
const ADJ=NODES.map(()=>[]);
EDGES.forEach(([a,b])=>{ADJ[a].push(b);ADJ[b].push(a);});

function d2(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}
function nearestNode(x,y){
  let best=0,bd=1e9;
  NODES.forEach(n=>{const d=Math.hypot(n.x-x,n.y-y);if(d<bd){bd=d;best=n.id;}});
  return best;
}
function pathfind(s,e){
  if(s===e)return[s];
  const dist=Array(NODES.length).fill(Infinity),prev=Array(NODES.length).fill(-1);
  dist[s]=0;const vis=new Set(),q=[s];
  while(q.length){
    q.sort((a,b2)=>dist[a]-dist[b2]);
    const u=q.shift();if(vis.has(u))continue;vis.add(u);if(u===e)break;
    ADJ[u].forEach(v=>{const nd=dist[u]+d2(NODES[u],NODES[v]);if(nd<dist[v]){dist[v]=nd;prev[v]=u;q.push(v);}});
  }
  const p=[];let c=e;while(c!==-1){p.unshift(c);c=prev[c];}
  return p.length>1?p:[s,e];
}
function pathLen(path){let d=0;for(let i=0;i<path.length-1;i++)d+=d2(NODES[path[i]],NODES[path[i+1]]);return d;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  CITY BLOCKS  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CELL_DEFS=[
  {col:0, row:0,t:'water',        lb:'NORTH\nHARBOR'},
  {col:1, row:0,t:'water',        lb:'HARBOR\nBAY'},
  {col:2, row:0,t:'commercial',   lb:'FISH\nMARKET'},
  {col:3, row:0,t:'civic',        lb:'CITY\nHALL'},
  {col:4, row:0,t:'civic',        lb:'COURT\nHOUSE'},
  {col:5, row:0,t:'hospital',     lb:'MEMORIAL\nHOSPITAL'},
  {col:6, row:0,t:'block',        lb:'NORTH\nHILL'},
  {col:7, row:0,t:'block',        lb:'EAST\nRIDGE'},
  {col:8, row:0,t:'commercial',   lb:'TECH\nPARK'},
  {col:9, row:0,t:'block',        lb:'AIRPORT\nROAD'},
  {col:10,row:0,t:'water',        lb:'EAST\nHARBOR'},
  {col:0, row:1,t:'block',        lb:'OLD PORT'},
  {col:1, row:1,t:'station_police',lb:'POLICE HQ'},
  {col:2, row:1,t:'park',         lb:'CENTRAL\nPARK'},
  {col:3, row:1,t:'block',        lb:'MIDTOWN'},
  {col:4, row:1,t:'block',        lb:'FINANCE\nDIST'},
  {col:5, row:1,t:'commercial',   lb:'GRAND\nSTATION'},
  {col:6, row:1,t:'block',        lb:'EAST\nDOCKS'},
  {col:7, row:1,t:'commercial',   lb:'MEDIA\nCENTRE'},
  {col:8, row:1,t:'block',        lb:'SILICON\nROW'},
  {col:9, row:1,t:'station_heli', lb:'HELIPORT'},
  {col:10,row:1,t:'block',        lb:'AIRPORT\nDIST'},
  {col:0, row:2,t:'block',        lb:'RIVERSIDE'},
  {col:1, row:2,t:'block',        lb:'WEST END'},
  {col:2, row:2,t:'park',         lb:'RIVERSIDE\nPARK'},
  {col:3, row:2,t:'civic',        lb:'LIBRARY SQ'},
  {col:4, row:2,t:'commercial',   lb:'HOTEL ROW'},
  {col:5, row:2,t:'station_amb',  lb:'EMS BASE'},
  {col:6, row:2,t:'block',        lb:'EASTSIDE'},
  {col:7, row:2,t:'block',        lb:'EAST\nGARDENS'},
  {col:8, row:2,t:'commercial',   lb:'MALL\nDIST'},
  {col:9, row:2,t:'block',        lb:'GROVE\nPARK'},
  {col:10,row:2,t:'block',        lb:'FAR EAST'},
  {col:0, row:3,t:'water',        lb:'SOUTH\nINLET'},
  {col:1, row:3,t:'block',        lb:'SOUTH WEST'},
  {col:2, row:3,t:'commercial',   lb:'BROAD ST'},
  {col:3, row:3,t:'block',        lb:'THEATER\nDIST'},
  {col:4, row:3,t:'block',        lb:'HILLCREST'},
  {col:5, row:3,t:'block',        lb:'HARBOR\nVIEW'},
  {col:6, row:3,t:'block',        lb:'MILL DIST'},
  {col:7, row:3,t:'civic',        lb:'MUSEUM\nQUARTER'},
  {col:8, row:3,t:'block',        lb:'NORTH\nSUBURBS'},
  {col:9, row:3,t:'block',        lb:'PINE\nESTATE'},
  {col:10,row:3,t:'park',         lb:'EAST\nCOMMON'},
  {col:0, row:4,t:'block',        lb:'SOUTH POINT'},
  {col:1, row:4,t:'station_fire', lb:'FIRE STN\nNO. 1'},
  {col:2, row:4,t:'park',         lb:'MEMORIAL\nGARDENS'},
  {col:3, row:4,t:'block',        lb:'CHINATOWN'},
  {col:4, row:4,t:'block',        lb:'ARTS\nQUARTER'},
  {col:5, row:4,t:'commercial',   lb:'INDUSTRIAL\nZONE'},
  {col:6, row:4,t:'block',        lb:'STADIUM DIST'},
  {col:7, row:4,t:'block',        lb:'SOUTH\nRIDGE'},
  {col:8, row:4,t:'block',        lb:'ASHFORD\nESTATE'},
  {col:9, row:4,t:'commercial',   lb:'RETAIL\nPARK'},
  {col:10,row:4,t:'block',        lb:'SOUTH EAST'},
  {col:0, row:5,t:'water',        lb:'WEST\nBEACH'},
  {col:1, row:5,t:'block',        lb:'BRICKWORKS'},
  {col:2, row:5,t:'block',        lb:'SOUTH\nLEA'},
  {col:3, row:5,t:'block',        lb:'RIVER\nGATE'},
  {col:4, row:5,t:'block',        lb:'VALE\nPARK'},
  {col:5, row:5,t:'civic',        lb:'CIVIC\nCENTRE'},
  {col:6, row:5,t:'commercial',   lb:'WAREHOUSE\nDIST'},
  {col:7, row:5,t:'block',        lb:'PORTSIDE'},
  {col:8, row:5,t:'block',        lb:'SOUTH\nPOLICE'},
  {col:9, row:5,t:'block',        lb:'GREENBELT'},
  {col:10,row:5,t:'block',        lb:'FARSIDE'},
  {col:0, row:6,t:'water',        lb:'SOUTH\nBAY'},
  {col:1, row:6,t:'block',        lb:'DOCKERS\nROW'},
  {col:2, row:6,t:'block',        lb:'WEST\nDOCKS'},
  {col:3, row:6,t:'park',         lb:'SOUTHERN\nPARK'},
  {col:4, row:6,t:'block',        lb:'SOUTH\nGATE'},
  {col:5, row:6,t:'block',        lb:'MERSEY\nDOCKS'},
  {col:6, row:6,t:'civic',        lb:'SOUTH\nMEDICAL'},
  {col:7, row:6,t:'block',        lb:'ORION\nESTATE'},
  {col:8, row:6,t:'block',        lb:'NEWTON\nHEATH'},
  {col:9, row:6,t:'commercial',   lb:'FOOD DIST'},
  {col:10,row:6,t:'block',        lb:'OUTER EAST'},
  {col:0, row:7,t:'water',        lb:'DEEP\nSOUTH'},
  {col:1, row:7,t:'block',        lb:'SOUTH POINT'},
  {col:2, row:7,t:'block',        lb:'LAKESIDE'},
  {col:3, row:7,t:'block',        lb:'LOWFIELDS'},
  {col:4, row:7,t:'block',        lb:'WESTBROOK'},
  {col:5, row:7,t:'block',        lb:'SOUTH\nEMS'},
  {col:6, row:7,t:'block',        lb:'EAST MOOR'},
  {col:7, row:7,t:'block',        lb:'COPPERFIELD'},
  {col:8, row:7,t:'block',        lb:'BOUNDARY\nEND'},
  {col:9, row:7,t:'water',        lb:'ESTUARY'},
  {col:10,row:7,t:'water',        lb:'FAR\nESTUARY'},
];

/* Station defs */
const STATION_DEFS={
  police:{cellCol:1,cellRow:1},
  fire:  {cellCol:1,cellRow:4},
  amb:   {cellCol:5,cellRow:2},
  heli:  {cellCol:9,cellRow:1},
};
Object.entries(STATION_DEFS).forEach(([type,s])=>{
  s.nid=nid(s.cellCol,s.cellRow);
  s.x=CX[s.cellCol]; s.y=RY[s.cellRow];
});

/* Hospitals â€” node at top-left corner of their cell */
// Single hospital - Memorial Hospital (col 5, row 0)
const HOSPITAL={nid:nid(5,0), x:(CX[5]+CX[6])/2, y:(RY[0]+RY[1])/2};
function nearestHospital(){return HOSPITAL;}

const UCOLS={police:'#4499ff',fire:'#ff5500',amb:'#ff3399',heli:'#aa44ff'};
const UICONS={police:'ğŸš”',fire:'ğŸš’',amb:'ğŸš‘',heli:'ğŸš'};
const BCOL={
  water:          {f:'#0a2636',s:'#0d3654',l:'#1a5272'},
  park:           {f:'#0a2214',s:'#0d2e18',l:'#1a5828'},
  block:          {f:'#0c1d2c',s:'#152e44',l:'#2a4862'},
  commercial:     {f:'#0e1f35',s:'#192f4c',l:'#2a5080'},
  civic:          {f:'#0e1f32',s:'#1a3248',l:'#286a80'},
  hospital:       {f:'#0c2030',s:'#163c40',l:'#1a8080'},
  station_police: {f:'#0a1a30',s:'#2244aa',l:'#4499ff'},
  station_fire:   {f:'#2a0e00',s:'#aa3300',l:'#ff5500'},
  station_amb:    {f:'#2a0018',s:'#aa0055',l:'#ff3399'},
  station_heli:   {f:'#1a0a30',s:'#6622aa',l:'#aa44ff'},
};

/* Baked windows */
const BLOCK_WINDOWS={};
CELL_DEFS.forEach(b=>{
  if(!['block','commercial','civic'].includes(b.t))return;
  const key=`${b.col}_${b.row}`;
  BLOCK_WINDOWS[key]=[];
  for(let wr=0;wr<4;wr++) for(let wc=0;wc<5;wc++)
    BLOCK_WINDOWS[key].push({fx:(wc+.5)/5,fy:(wr+.5)/4,lit:Math.random()<0.42});
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  EMERGENCY TYPES  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   wt = spawn weight (higher = more common).
   Early waves favour low-wt single-unit calls.
   Multi-unit and heli calls become common by wave 4+.
*/
const ET=[
  // Single-unit â€” most common early
  {n:'ROBBERY',          nd:['police'],              sv:'HIGH',    rw:240, cl:'police', wt:9, ds:'Armed robbery in progress.'},
  {n:'CARDIAC ARREST',   nd:['amb'],                 sv:'CRITICAL',rw:210, cl:'amb',    wt:9, ds:'Unresponsive patient. EMS needed urgently.'},
  {n:'GAS LEAK',         nd:['fire'],                sv:'HIGH',    rw:220, cl:'fire',   wt:9, ds:'Gas leak at residence. Fire unit required.'},
  {n:'OVERDOSE',         nd:['amb'],                 sv:'HIGH',    rw:180, cl:'amb',    wt:9, ds:'Drug overdose reported.'},
  {n:'BURGLARY',         nd:['police'],              sv:'LOW',     rw:160, cl:'police', wt:9, ds:'Active break-in reported.'},
  {n:'SMALL FIRE',       nd:['fire'],                sv:'MEDIUM',  rw:200, cl:'fire',   wt:7, ds:'Vehicle or rubbish fire.'},
  // Two-unit â€” moderate
  {n:'CAR ACCIDENT',     nd:['police','amb'],         sv:'MEDIUM',  rw:310, cl:'amb',    wt:5, ds:'Multi-vehicle crash with injuries.'},
  {n:'STRUCTURE FIRE',   nd:['fire','amb'],           sv:'CRITICAL',rw:420, cl:'fire',   wt:5, ds:'Building fire with casualties.'},
  {n:'SHOOTING',         nd:['police','amb'],         sv:'CRITICAL',rw:390, cl:'police', wt:4, ds:'Active shooter. Police & paramedics needed.'},
  {n:'FLOOD RESCUE',     nd:['fire','amb'],           sv:'MEDIUM',  rw:300, cl:'fire',   wt:4, ds:'Flash flood trapping residents.'},
  {n:'RIOT',             nd:['police','police'],      sv:'HIGH',    rw:360, cl:'police', wt:4, ds:'Civil unrest. Two police units required.'},
  {n:'CHEMICAL SPILL',   nd:['fire','police'],        sv:'HIGH',    rw:330, cl:'fire',   wt:4, ds:'Hazmat spill. Fire & police needed.'},
  {n:'BANK ROBBERY',     nd:['police','police'],      sv:'HIGH',    rw:370, cl:'police', wt:4, ds:'Armed bank robbery. Two units required.'},
  // Helicopter â€” appear regularly from wave 1
  {n:'CLIFF RESCUE',     nd:['heli'],                sv:'HIGH',    rw:370, cl:'heli',   wt:7, ds:'Person stranded. Air rescue needed.'},
  {n:'MISSING PERSON',   nd:['police','heli'],        sv:'MEDIUM',  rw:310, cl:'police', wt:6, ds:'Missing person. Ground & air search.'},
  {n:'MAJOR TRAUMA',     nd:['amb','heli'],           sv:'CRITICAL',rw:470, cl:'amb',    wt:5, ds:'Severe trauma. EMS + air ambulance.'},
  // Three-unit â€” rare, wave 4+
  {n:'WILDFIRE',         nd:['fire','fire'],          sv:'CRITICAL',rw:490, cl:'fire',   wt:2, ds:'Wildfire spreading. Two fire units needed.'},
  {n:'EXPLOSION',        nd:['fire','police','amb'],  sv:'CRITICAL',rw:570, cl:'fire',   wt:2, ds:'Explosion! All services needed!'},
  {n:'BUILDING COLLAPSE',nd:['fire','fire','amb'],    sv:'CRITICAL',rw:640, cl:'fire',   wt:2, ds:'Building collapse. Multiple casualties.'},
];

/* Ensure we don't cluster same service type in rapid succession.
   Also guarantee a heli call appears at least every 5 spawns. */
let lastSpawnCl=null;
let spawnsSinceHeli=0;
function pickET(){
  // Force a heli call if we haven't seen one in 5 spawns and wave >= 1
  const forceHeli = spawnsSinceHeli>=5 && G.wave>=1;

  const allowed=ET.filter(e=>{
    if(forceHeli) return e.nd.includes('heli');
    if(G.wave<=2 && e.nd.length>=3 && !e.nd.includes('heli')) return false;
    return true;
  });
  const pool=[];
  allowed.forEach(e=>{for(let i=0;i<e.wt;i++) pool.push(e);});
  let pick=pool[Math.floor(Math.random()*pool.length)];
  // Try up to 4 times to avoid same class as last (unless forcing heli)
  if(!forceHeli){
    for(let i=0;i<4;i++){
      if(pick.cl!==lastSpawnCl) break;
      pick=pool[Math.floor(Math.random()*pool.length)];
    }
  }
  lastSpawnCl=pick.cl;
  if(pick.nd.includes('heli')) spawnsSinceHeli=0;
  else spawnsSinceHeli++;
  return pick;
}

const ELOCS=CELL_DEFS
  .filter(b=>!b.t.startsWith('station')&&b.t!=='hospital')
  .map(b=>({n:b.lb.replace('\n',' '),x:(CX[b.col]+CX[b.col+1])/2,y:(RY[b.row]+RY[b.row+1])/2}));

function spawnEm(){
  const maxInc=Math.min(3+Math.floor(G.wave*1.4)+(G.capBonus||0),14);
  if(G.ems.length>=maxInc) return;
  const et=pickET();
  const loc=ELOCS[Math.floor(Math.random()*ELOCS.length)];
  G.ems.push({
    id:G.nextId++,type:et.n,needs:[...et.nd],sv:et.sv,
    rw:et.rw,cl:et.cl,desc:et.ds,
    x:loc.x,y:loc.y,loc:loc.n,
    born:performance.now(),disp:[],fullyDisp:false,
  });
  sfxAlert();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  CANVAS  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const canvas=document.getElementById('map-canvas');
const ctx=canvas.getContext('2d');
let CW=0,CH=0;
function resize(){CW=canvas.width=canvas.offsetWidth;CH=canvas.height=canvas.offsetHeight;}
function mx(x){return x*CW;}
function my(y){return y*CH;}
function cellRect(col,row){
  const rw=Math.max(3,CW*0.006);
  const ins=rw*0.5+1;
  return{x:mx(CX[col])+ins,y:my(RY[row])+ins,w:mx(CX[col+1])-mx(CX[col])-ins*2,h:my(RY[row+1])-my(RY[row])-ins*2};
}

let mapCanvas=null;
function buildMapCanvas(){
  mapCanvas=document.createElement('canvas');
  mapCanvas.width=CW;mapCanvas.height=CH;
  const mc=mapCanvas.getContext('2d');
  mc.fillStyle='#0b1720';mc.fillRect(0,0,CW,CH);

  const rw=Math.max(3,CW*0.006);
  EDGES.forEach(([a,b])=>{const A=NODES[a],B=NODES[b];mc.strokeStyle='#1a3750';mc.lineWidth=rw*2;mc.lineCap='square';mc.beginPath();mc.moveTo(mx(A.x),my(A.y));mc.lineTo(mx(B.x),my(B.y));mc.stroke();});
  EDGES.forEach(([a,b])=>{const A=NODES[a],B=NODES[b];mc.strokeStyle='#213e55';mc.lineWidth=rw*.9;mc.beginPath();mc.moveTo(mx(A.x),my(A.y));mc.lineTo(mx(B.x),my(B.y));mc.stroke();});
  mc.setLineDash([4,7]);mc.lineWidth=0.6;
  EDGES.forEach(([a,b])=>{const A=NODES[a],B=NODES[b];mc.strokeStyle='rgba(40,85,125,.38)';mc.beginPath();mc.moveTo(mx(A.x),my(A.y));mc.lineTo(mx(B.x),my(B.y));mc.stroke();});
  mc.setLineDash([]);
  NODES.forEach(n=>{mc.fillStyle='#1d3f58';mc.fillRect(mx(n.x)-rw,my(n.y)-rw,rw*2,rw*2);});

  CELL_DEFS.forEach(b=>{
    const c=BCOL[b.t]||BCOL.block;
    const r=cellRect(b.col,b.row);
    if(r.w<=0||r.h<=0)return;

    mc.fillStyle='rgba(0,0,0,.26)';mc.fillRect(r.x+2,r.y+2,r.w,r.h);
    mc.fillStyle=c.f;mc.fillRect(r.x,r.y,r.w,r.h);
    mc.strokeStyle=c.s;mc.lineWidth=1;mc.strokeRect(r.x,r.y,r.w,r.h);

    if(b.t==='park'){mc.fillStyle='rgba(0,80,25,.3)';for(let tx=r.x+5;tx<r.x+r.w-3;tx+=9)for(let ty=r.y+5;ty<r.y+r.h-3;ty+=9){mc.beginPath();mc.arc(tx,ty,3.5,0,Math.PI*2);mc.fill();}}
    if(b.t==='water'){mc.strokeStyle='rgba(0,110,190,.18)';mc.lineWidth=0.7;for(let ry2=r.y+7;ry2<r.y+r.h-4;ry2+=9){mc.beginPath();mc.moveTo(r.x+3,ry2);for(let rx2=r.x+3;rx2<r.x+r.w-3;rx2+=14)mc.bezierCurveTo(rx2+4,ry2-2,rx2+8,ry2+2,rx2+14,ry2);mc.stroke();}}
    if(b.t==='hospital'){mc.fillStyle='rgba(0,180,180,.18)';mc.fillRect(r.x,r.y,r.w,r.h);mc.fillStyle='rgba(0,220,200,.32)';mc.fillRect(r.x+r.w*.42,r.y+4,r.w*.16,r.h-8);mc.fillRect(r.x+4,r.y+r.h*.42,r.w-8,r.h*.16);}

    const key=`${b.col}_${b.row}`;
    if(BLOCK_WINDOWS[key])BLOCK_WINDOWS[key].forEach(w=>{mc.fillStyle=w.lit?'rgba(200,230,255,.12)':'rgba(20,50,90,.05)';mc.fillRect(r.x+w.fx*r.w-2,r.y+w.fy*r.h-2,4,4);});

    if(b.t.startsWith('station')){
      const type=b.t.replace('station_','');
      const col=UCOLS[type]||'#fff';
      mc.fillStyle=col+'14';mc.fillRect(r.x,r.y,r.w,r.h);
      mc.save();mc.shadowColor=col;mc.shadowBlur=7;mc.strokeStyle=col;mc.lineWidth=1.4;mc.strokeRect(r.x+1,r.y+1,r.w-2,r.h-2);mc.restore();
      mc.font=`${Math.min(r.w,r.h)*0.28}px serif`;mc.textAlign='center';mc.textBaseline='middle';mc.fillText(UICONS[type]||'ğŸ¢',r.x+r.w*.5,r.y+r.h*.38);
      mc.fillStyle=col;mc.font=`bold ${Math.max(5,Math.min(r.w*.1,8))}px Barlow Condensed`;mc.textAlign='center';mc.textBaseline='middle';
      b.lb.split('\n').forEach((ln,i,arr)=>mc.fillText(ln,r.x+r.w/2,r.y+r.h*.73+(i-(arr.length-1)/2)*8));
      mc.textBaseline='alphabetic';return;
    }
    mc.fillStyle=c.l;mc.font=`${Math.max(5,Math.min(r.w*.09,7))}px Barlow Condensed`;mc.textAlign='center';mc.textBaseline='middle';
    b.lb.split('\n').forEach((ln,i,arr)=>mc.fillText(ln,r.x+r.w/2,r.y+r.h/2+(i-(arr.length-1)/2)*8));
    mc.textBaseline='alphabetic';
  });

  // Compass
  const crx=CW-19,cry=CH-19;
  mc.globalAlpha=.52;mc.fillStyle='rgba(4,9,16,.8)';mc.beginPath();mc.arc(crx,cry,13,0,Math.PI*2);mc.fill();
  mc.strokeStyle='#2a5070';mc.lineWidth=0.7;mc.stroke();
  mc.fillStyle='#4499ff';mc.font='bold 7px Barlow Condensed';mc.textAlign='center';mc.textBaseline='middle';
  mc.fillText('N',crx,cry-5);mc.fillStyle='#5a7a99';mc.fillText('S',crx,cry+5);mc.fillText('E',crx+6,cry);mc.fillText('W',crx-6,cry);
  mc.globalAlpha=1;mc.textBaseline='alphabetic';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  DRAW EMERGENCIES  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawEmergencies(t){
  G.ems.forEach(e=>{
    const ex=mx(e.x),ey=my(e.y);
    const et=ET.find(x=>x.n===e.type);
    const col=UCOLS[et.cl];
    const pulse=.78+.22*Math.sin(t/270);
    const tMax=Math.max(18000,34000-G.wave*1200);
    const urgency=Math.min(1,(t-e.born)/tMax);

    // Timeout arc
    ctx.beginPath();ctx.arc(ex,ey,19,0,Math.PI*2);ctx.strokeStyle='rgba(255,60,60,.07)';ctx.lineWidth=2;ctx.stroke();
    ctx.beginPath();ctx.arc(ex,ey,19,-Math.PI/2,-Math.PI/2+(1-urgency)*Math.PI*2);ctx.strokeStyle=urgency>.7?'#ff3333':col+'88';ctx.lineWidth=2;ctx.stroke();
    // Pulse circle
    ctx.beginPath();ctx.arc(ex,ey,10*pulse,0,Math.PI*2);ctx.fillStyle=col+'16';ctx.fill();ctx.strokeStyle=col;ctx.lineWidth=1;ctx.stroke();
    // Icon
    ctx.font='11px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('ğŸš¨',ex,ey);ctx.textBaseline='alphabetic';
    // Label
    ctx.fillStyle=urgency>.7?'#ff6666':col;
    ctx.font=`bold ${Math.max(6,Math.min(CW*.012,8))}px Barlow Condensed`;ctx.textAlign='center';
    ctx.fillText(e.type,ex,ey-21);
    // Progress bars
    let barY=ey+23;
    e.disp.forEach(d=>{
      if(!d.inProg)return;
      const pg=Math.min(1,d.progress||0);
      ctx.fillStyle='rgba(0,0,0,.7)';ctx.fillRect(ex-17,barY-3,34,5);
      ctx.fillStyle=UCOLS[d.type];ctx.fillRect(ex-17,barY-3,34*pg,5);
      barY+=8;
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  PATH POSITION  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function posOnPath(path,pp){
  if(!path||path.length<2)return null;
  const segs=[];let total=0;
  for(let i=0;i<path.length-1;i++){const dd=d2(NODES[path[i]],NODES[path[i+1]]);segs.push(dd);total+=dd;}
  if(total===0)return{x:mx(NODES[path[0]].x),y:my(NODES[path[0]].y),angle:0};
  let target=Math.min(0.9999,pp)*total;
  for(let i=0;i<segs.length;i++){
    if(target<=segs[i]+1e-5||i===segs.length-1){
      const t2=segs[i]>1e-5?Math.min(1,target/segs[i]):0;
      const A=NODES[path[i]],B=NODES[path[i+1]];
      return{x:mx(A.x+(B.x-A.x)*t2),y:my(A.y+(B.y-A.y)*t2),angle:Math.atan2(my(B.y)-my(A.y),mx(B.x)-mx(A.x))};
    }
    target-=segs[i];
  }
  const A=NODES[path[path.length-2]],B=NODES[path[path.length-1]];
  return{x:mx(B.x),y:my(B.y),angle:Math.atan2(my(B.y)-my(A.y),mx(B.x)-mx(A.x))};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  TOP-DOWN VEHICLES  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawVehicleTopDown(ctx,vx,vy,angle,col,type,t,active,returning,working){
  const BL=6,BW=3.5;
  const flashRate=type==='police'?160:type==='fire'?300:type==='heli'?200:220;
  const beat=Math.floor(t/flashRate)%2;
  const lightCol=type==='police'?(beat?'#ff2233':'#55aaff')
                :type==='fire'  ?(beat?'#ffdd00':'#ff6600')
                :type==='heli'  ?(beat?'#dd99ff':'#cc66ff')
                :                (beat?'#ffddff':'#ff44aa');

  ctx.save();
  ctx.translate(vx,vy);

  if(type==='heli'){
    ctx.rotate(angle);
    ctx.globalAlpha=returning?0.72:1;
    const HS=11;

    // Altitude shadow
    ctx.fillStyle='rgba(0,0,0,0.18)';
    ctx.beginPath();ctx.ellipse(5,6,HS*0.9,HS*0.5,0,0,Math.PI*2);ctx.fill();

    // Main rotor blur disc
    const spin=(t/40)%(Math.PI*2);
    const rg=ctx.createRadialGradient(0,0,0,0,0,HS*1.6);
    rg.addColorStop(0,col+'22');rg.addColorStop(0.7,col+'0a');rg.addColorStop(1,'transparent');
    ctx.fillStyle=rg;
    ctx.beginPath();ctx.ellipse(0,0,HS*1.6,HS*1.6,0,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle=col+'28';ctx.lineWidth=1.2;
    ctx.beginPath();ctx.ellipse(0,0,HS*1.55,HS*1.55,0,0,Math.PI*2);ctx.stroke();
    // Primary blades
    ctx.save();ctx.rotate(spin);
    ctx.strokeStyle=col+'60';ctx.lineWidth=2.8;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(-HS*1.5,0);ctx.lineTo(HS*1.5,0);ctx.stroke();
    ctx.strokeStyle='rgba(0,0,0,0.2)';ctx.lineWidth=0.8;
    ctx.beginPath();ctx.moveTo(-HS*1.5,0);ctx.lineTo(HS*1.5,0);ctx.stroke();
    ctx.restore();
    // Secondary blades (4-blade look)
    ctx.save();ctx.rotate(spin+Math.PI/2);
    ctx.strokeStyle=col+'40';ctx.lineWidth=2;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(-HS*1.4,0);ctx.lineTo(HS*1.4,0);ctx.stroke();
    ctx.restore();

    // Fuselage teardrop (nose = +x)
    ctx.fillStyle='#110824';
    ctx.beginPath();
    ctx.moveTo(HS*.85,0);
    ctx.bezierCurveTo(HS*.75,-HS*.5,-HS*.25,-HS*.52,-HS*.48,0);
    ctx.bezierCurveTo(-HS*.25,HS*.52,HS*.75,HS*.5,HS*.85,0);
    ctx.closePath();ctx.fill();
    ctx.strokeStyle=col;ctx.lineWidth=1.1;ctx.stroke();

    // Livery stripe
    ctx.fillStyle=col+'50';
    ctx.beginPath();
    ctx.moveTo(HS*.15,-HS*.13);ctx.lineTo(-HS*.38,-HS*.11);
    ctx.lineTo(-HS*.38,HS*.11);ctx.lineTo(HS*.15,HS*.13);
    ctx.closePath();ctx.fill();

    // Cockpit bubble
    ctx.fillStyle='rgba(120,195,255,0.40)';ctx.strokeStyle='rgba(200,240,255,0.55)';ctx.lineWidth=0.7;
    ctx.beginPath();
    ctx.moveTo(HS*.85,0);
    ctx.bezierCurveTo(HS*.75,-HS*.38,HS*.12,-HS*.38,HS*.08,0);
    ctx.bezierCurveTo(HS*.12,HS*.38,HS*.75,HS*.38,HS*.85,0);
    ctx.closePath();ctx.fill();ctx.stroke();
    // Glare
    ctx.fillStyle='rgba(255,255,255,0.22)';
    ctx.beginPath();ctx.ellipse(HS*.56,-HS*.13,HS*.12,HS*.065,-0.35,0,Math.PI*2);ctx.fill();

    // Tail boom
    ctx.fillStyle='#0c0618';ctx.strokeStyle=col+'38';ctx.lineWidth=0.7;
    ctx.beginPath();
    ctx.moveTo(-HS*.42,-HS*.1);ctx.lineTo(-HS*1.6,-HS*.05);
    ctx.lineTo(-HS*1.6,HS*.05);ctx.lineTo(-HS*.42,HS*.1);
    ctx.closePath();ctx.fill();ctx.stroke();
    // Tail fin
    ctx.fillStyle=col+'28';ctx.strokeStyle=col+'55';ctx.lineWidth=0.6;
    ctx.beginPath();ctx.moveTo(-HS*.95,-HS*.04);ctx.lineTo(-HS*1.52,-HS*.36);ctx.lineTo(-HS*1.6,-HS*.04);ctx.closePath();
    ctx.fill();ctx.stroke();

    // Tail rotor
    const tailSpin=(t/28)%(Math.PI*2);
    ctx.save();ctx.translate(-HS*1.6,0);ctx.rotate(tailSpin);
    ctx.strokeStyle=col+'80';ctx.lineWidth=1;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(0,-HS*.38);ctx.lineTo(0,HS*.38);ctx.stroke();
    ctx.beginPath();ctx.moveTo(-HS*.38,0);ctx.lineTo(HS*.38,0);ctx.stroke();
    ctx.restore();

    // Skids
    ctx.strokeStyle=col+'55';ctx.lineWidth=1.1;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(HS*.52,-HS*.58);ctx.lineTo(-HS*.32,-HS*.58);ctx.stroke();
    ctx.beginPath();ctx.moveTo(HS*.28,-HS*.52);ctx.lineTo(HS*.28,-HS*.68);ctx.stroke();
    ctx.beginPath();ctx.moveTo(-HS*.08,-HS*.52);ctx.lineTo(-HS*.08,-HS*.68);ctx.stroke();
    ctx.beginPath();ctx.moveTo(HS*.52,HS*.58);ctx.lineTo(-HS*.32,HS*.58);ctx.stroke();
    ctx.beginPath();ctx.moveTo(HS*.28,HS*.52);ctx.lineTo(HS*.28,HS*.68);ctx.stroke();
    ctx.beginPath();ctx.moveTo(-HS*.08,HS*.52);ctx.lineTo(-HS*.08,HS*.68);ctx.stroke();

    // Rotor hub
    ctx.fillStyle='#1e2c40';ctx.strokeStyle=col;ctx.lineWidth=0.9;
    ctx.beginPath();ctx.arc(0,0,HS*.16,0,Math.PI*2);ctx.fill();ctx.stroke();

    // Beacon
    if(active||working){
      const ba=(t/180)%(Math.PI*2);
      ctx.fillStyle=lightCol;
      ctx.beginPath();ctx.arc(Math.cos(ba)*HS*.16,Math.sin(ba)*HS*.16,2,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=(returning?0.72:1)*0.12;
      ctx.fillStyle=lightCol;ctx.beginPath();ctx.arc(0,0,HS*.75,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=returning?0.72:1;
    }
    ctx.globalAlpha=1;ctx.restore();return;
  }

  // Ground vehicle
  ctx.rotate(angle);
  ctx.globalAlpha=returning?0.7:1;
  // Shadow
  ctx.fillStyle='rgba(0,0,0,.36)';
  ctx.beginPath();if(ctx.roundRect)ctx.roundRect(1-BL,1-BW,BL*2,BW*2,2);else ctx.rect(1-BL,1-BW,BL*2,BW*2);ctx.fill();
  // Body
  const bodyCol=type==='police'?'#0d1f3c':type==='fire'?'#3d0e00':'#2a0520';
  ctx.fillStyle=bodyCol;ctx.strokeStyle=col;ctx.lineWidth=1;
  ctx.beginPath();if(ctx.roundRect)ctx.roundRect(-BL,-BW,BL*2,BW*2,2);else ctx.rect(-BL,-BW,BL*2,BW*2);ctx.fill();ctx.stroke();
  // Roof tint
  ctx.fillStyle=col+'1a';ctx.beginPath();if(ctx.roundRect)ctx.roundRect(-BL+2,-BW+1.5,BL*2-4,BW*2-3,1.5);else ctx.rect(-BL+2,-BW+1.5,BL*2-4,BW*2-3);ctx.fill();
  // Markings
  if(type==='police'){ctx.fillStyle='#ffffff14';for(let i=0;i<4;i++)if(i%2===0){ctx.fillRect(-BL+2+i*3,-BW,3,2);ctx.fillRect(-BL+2+i*3,BW-2,3,2);}}
  else if(type==='fire'){ctx.fillStyle='#ffcc003a';ctx.beginPath();ctx.moveTo(-BL,-BW);ctx.lineTo(-BL+3,0);ctx.lineTo(-BL,BW);ctx.closePath();ctx.fill();}
  else{ctx.fillStyle='#ff33993a';ctx.fillRect(-BL+1,-0.7,BL*2-2,1.4);}
  // Windscreen
  ctx.fillStyle='rgba(140,210,255,.36)';ctx.beginPath();if(ctx.roundRect)ctx.roundRect(BL-3.5,-BW+1.5,3,BW*2-3,1);else ctx.rect(BL-3.5,-BW+1.5,3,BW*2-3);ctx.fill();
  ctx.fillStyle='rgba(100,160,200,.16)';ctx.fillRect(-BL+0.5,-BW+1.5,2.5,BW*2-3);
  // Wheels
  ctx.fillStyle='#080e18';ctx.strokeStyle='#1e3040';ctx.lineWidth=0.4;
  [[BL-2,-BW-.8],[BL-2,BW+.8],[-(BL-2),-BW-.8],[-(BL-2),BW+.8]].forEach(([dx,dy])=>{ctx.fillRect(dx-1.4,dy-.9,2.8,1.8);ctx.strokeRect(dx-1.4,dy-.9,2.8,1.8);});
  // Lights
  ctx.fillStyle='rgba(255,248,180,.75)';
  ctx.beginPath();ctx.ellipse(BL-.4,-BW+1.1,1.5,1,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(BL-.4, BW-1.1,1.5,1,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,30,30,.58)';
  ctx.beginPath();ctx.ellipse(-BL+.7,-BW+1.1,1.2,.8,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(-BL+.7, BW-1.1,1.2,.8,0,0,Math.PI*2);ctx.fill();
  // Rotating beacon
  if(active||working){
    const ba=(t/280)%(Math.PI*2);
    const bx=Math.cos(ba)*2,by=Math.sin(ba)*2;
    ctx.fillStyle='#0e1520';ctx.beginPath();ctx.arc(0,0,1.5,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=lightCol;ctx.beginPath();ctx.arc(bx,by,1.8,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=(returning?0.7:1)*.18;
    ctx.fillStyle=lightCol;ctx.beginPath();ctx.arc(bx*2.8,by*2.8,4,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=returning?0.7:1;
  }
  ctx.globalAlpha=1;ctx.restore();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  DRAW VEHICLES  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function heliPos(v){
  // Returns {x,y,angle} for current heli phase using straight-line lerp
  let ax,ay,bx,by;
  if(v.phase==='going'){
    ax=v.sx;ay=v.sy;bx=v.ex;by=v.ey;
  } else if(v.phase==='toHosp'){
    ax=v.hsx||v.ex;ay=v.hsy||v.ey;bx=v.hhx||v.ex;by=v.hhy||v.ey;
  } else if(v.phase==='returning'){
    ax=v.rsx||v.hhx||v.ex;ay=v.rsy||v.hhy||v.ey;bx=v.rrx||v.sx;by=v.rry||v.sy;
  } else return null;
  const pp=Math.min(1,v.pp);
  return{
    x:mx(ax+(bx-ax)*pp),
    y:my(ay+(by-ay)*pp),
    angle:Math.atan2(my(by)-my(ay),mx(bx)-mx(ax)),
  };
}

function drawVehicles(t){
  G.vehs.forEach(v=>{
    const col=UCOLS[v.type];

    if(v.phase==='working'){
      const em=G.ems.find(e=>e.id===v.eid);if(!em)return;
      drawVehicleTopDown(ctx,mx(em.x)+11,my(em.y)-4,0,col,v.type,t,false,false,true);
      return;
    }
    // Heli landed at hospital â€” draw parked there
    if(v.type==='heli'&&v.phase==='landed'){
      const hosp=nearestHospital();
      drawVehicleTopDown(ctx,mx(hosp.x)+11,my(hosp.y)-4,0,col,'heli',t,false,false,true);
      // Show label
      ctx.fillStyle=col+'88';
      ctx.font=`bold ${Math.max(5,Math.min(CW*.01,7))}px Barlow Condensed`;ctx.textAlign='center';
      ctx.fillText('UNLOADING',mx(hosp.x),my(hosp.y)+16);
      return;
    }

    // Helicopter uses straight-line position
    if(v.type==='heli'){
      const pos=heliPos(v);if(!pos)return;
      const{x:vx,y:vy,angle}=pos;
      // Faint straight-line trail
      const isRet=v.phase==='returning'||v.phase==='toHosp';
      for(let s=5;s>=1;s--){
        const tpp=Math.max(0,v.pp-s*0.04);
        let tax,tay,tbx,tby;
        if(v.phase==='going'){tax=v.sx;tay=v.sy;tbx=v.ex;tby=v.ey;}
        else if(v.phase==='toHosp'){tax=v.hsx||v.ex;tay=v.hsy||v.ey;tbx=v.hhx||v.ex;tby=v.hhy||v.ey;}
        else{tax=v.rsx||v.ex;tay=v.rsy||v.ey;tbx=v.rrx||v.sx;tby=v.rry||v.sy;}
        const tx=mx(tax+(tbx-tax)*tpp),ty=my(tay+(tby-tay)*tpp);
        const alpha=isRet?(s===1?'22':'0e'):(s===1?'66':s===2?'33':'18');
        ctx.beginPath();ctx.arc(tx,ty,Math.max(.3,1.8-s*.28),0,Math.PI*2);
        ctx.fillStyle=col+alpha;ctx.fill();
      }
      drawVehicleTopDown(ctx,vx,vy,angle,col,'heli',t,v.phase==='going',isRet,false);
      return;
    }

    // Ground vehicles follow road paths
    const activePath=v.phase==='going'?v.path:v.phase==='toHosp'?v.hpath:v.rpath;
    if(!activePath||activePath.length<2)return;
    const pos=posOnPath(activePath,v.pp);if(!pos)return;
    const{x:vx,y:vy,angle}=pos;
    // Trail
    const total=pathLen(activePath);
    for(let s=4;s>=1;s--){
      const tp=posOnPath(activePath,Math.max(0,v.pp-(s*5)/(total*CW||1)));if(!tp)continue;
      const alpha=v.phase==='going'?(s===1?'88':s===2?'44':'1e'):(s===1?'22':'0e');
      ctx.beginPath();ctx.arc(tp.x,tp.y,Math.max(.4,2-s*.35),0,Math.PI*2);ctx.fillStyle=col+alpha;ctx.fill();
    }
    const isRet=v.phase==='returning'||v.phase==='toHosp';
    drawVehicleTopDown(ctx,vx,vy,angle,col,v.type,t,v.phase==='going',isRet,false);
    if(isRet){
      ctx.fillStyle=col+'66';
      ctx.font=`bold ${Math.max(5,Math.min(CW*.01,6))}px Barlow Condensed`;ctx.textAlign='center';
      ctx.fillText(v.phase==='toHosp'?'â†’HOSP':'RETURN',vx,vy+12);
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  FACE RATING  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FACES=['ğŸ˜¡','ğŸ˜Ÿ','ğŸ˜•','ğŸ˜','ğŸ™‚','ğŸ˜„'];
function faceForRating(r){return FACES[Math.max(0,Math.min(FACES.length-1,Math.round(r*(FACES.length-1)/5)))];}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  GAME STATE  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const G={
  money:0,score:0,resolved:0,rating:5,wave:1,capBonus:0,
  ems:[],vehs:[],nextId:1,
  spawnT:0,waveT:0,lastT:0,
  veh:{police:{total:1,busy:0},fire:{total:1,busy:0},amb:{total:1,busy:0},heli:{total:1,busy:0}},
  efficiency:1.0,upgrades:new Set(),gameOver:false,
};

function spawnInterval(){
  // Wave 1 = 18s, eases to 6s by wave 10
  const base=18000,min=6000,ramp=Math.min(1,(G.wave-1)/9);
  return base-(base-min)*ramp;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  GAME LOOP  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loop(t){
  if(G.gameOver)return;
  if(!G.lastT)G.lastT=t;
  const dt=Math.min(t-G.lastT,80);G.lastT=t;

  resize();
  if(!mapCanvas||mapCanvas.width!==CW||mapCanvas.height!==CH)buildMapCanvas();
  ctx.clearRect(0,0,CW,CH);
  ctx.drawImage(mapCanvas,0,0);
  drawEmergencies(t);
  drawVehicles(t);

  // Spawn
  G.spawnT+=dt;
  if(G.spawnT>=spawnInterval()){
    G.spawnT=0;
    spawnEm();
    if(G.wave>=5) setTimeout(()=>spawnEm(),2200);
    if(G.wave>=8) setTimeout(()=>spawnEm(),4400);
  }

  // Wave every 60s
  G.waveT+=dt;
  if(G.waveT>=60000){G.waveT=0;G.wave++;updateUI();}

  // Vehicles â€” smaller bodies, slower speed
  const SPD=0.09*(CW/400);
  const HSPD=SPD*1.5;

  G.vehs.forEach(v=>{
    const spd=v.type==='heli'?HSPD:SPD;

    // HELICOPTER: straight-line flight across the map, ignores roads
    if(v.type==='heli'){
      if(v.phase==='going'){
        const distPx=Math.hypot((v.ex-v.sx)*CW,(v.ey-v.sy)*CH)||1;
        v.pp=Math.min(1,v.pp+spd/distPx*dt);
        if(v.pp>=1){
          v.pp=0;v.phase='working';v.ws=t;
          const em=G.ems.find(e=>e.id===v.eid);
          if(em){const d=em.disp.find(d=>d.type==='heli'&&!d.inProg);if(d)d.inProg=true;}
          sfxSiren('heli');
        }
      }
      else if(v.phase==='working'){
        const pg=Math.min(1,(t-v.ws)/v.wd);
        const em=G.ems.find(e=>e.id===v.eid);
        if(em){const d=em.disp.find(d=>d.type==='heli'&&d.inProg&&!d.done);if(d)d.progress=pg;}
        if(pg>=1){
          const em2=G.ems.find(e=>e.id===v.eid);
          if(em2){const d=em2.disp.find(d=>d.type==='heli'&&d.inProg&&!d.done);if(d)d.done=true;checkResolved(v.eid);}
          const hosp=nearestHospital();
          v.hsx=v.ex;v.hsy=v.ey;
          v.hhx=hosp.x;v.hhy=hosp.y;
          v.phase='toHosp';v.pp=0;
        }
      }
      else if(v.phase==='toHosp'){
        const distPx=Math.hypot((v.hhx-v.hsx)*CW,(v.hhy-v.hsy)*CH)||1;
        v.pp=Math.min(1,v.pp+spd/distPx*dt);
        if(v.pp>=1){
          // Land at hospital â€” pause 3s to unload patient
          v.phase='landed';v.landedAt=t;v.pp=1;
        }
      }
      else if(v.phase==='landed'){
        if(t-v.landedAt>=3000){
          const st=STATION_DEFS.heli;
          v.rsx=v.hhx;v.rsy=v.hhy;
          v.rrx=st.x;v.rry=st.y;
          v.phase='returning';v.pp=0;
        }
      }
      else if(v.phase==='returning'){
        const distPx=Math.hypot((v.rrx-v.rsx)*CW,(v.rry-v.rsy)*CH)||1;
        v.pp=Math.min(1,v.pp+spd/distPx*dt);
        if(v.pp>=1){v.done=true;G.veh.heli.busy=Math.max(0,G.veh.heli.busy-1);updateCards();}
      }
    }
    // GROUND VEHICLES: follow road pathfinding
    else {
      if(v.phase==='going'){
        const plPx=pathLen(v.path)*CW;
        v.pp+=plPx>0?(spd/plPx)*dt:0.002*dt;
        if(v.pp>=1){
          v.pp=0;v.phase='working';v.ws=t;
          const em=G.ems.find(e=>e.id===v.eid);
          if(em){const d=em.disp.find(d=>d.type===v.type&&!d.inProg);if(d)d.inProg=true;}
          sfxSiren(v.type);
        }
      }
      else if(v.phase==='working'){
        const pg=Math.min(1,(t-v.ws)/v.wd);
        const em=G.ems.find(e=>e.id===v.eid);
        if(em){const d=em.disp.find(d=>d.type===v.type&&d.inProg&&!d.done);if(d)d.progress=pg;}
        if(pg>=1){
          const em2=G.ems.find(e=>e.id===v.eid);
          if(em2){const d=em2.disp.find(d=>d.type===v.type&&d.inProg&&!d.done);if(d)d.done=true;checkResolved(v.eid);}
          if(v.type==='amb'){
            const hosp=nearestHospital();
            v.hpath=pathfind(nearestNode(v.ex,v.ey),hosp.nid);
            v.hospNid=hosp.nid;
            v.phase='toHosp';v.pp=0;
          } else {
            const st=STATION_DEFS[v.type];
            v.rpath=pathfind(nearestNode(v.ex,v.ey),st.nid);
            v.phase='returning';v.pp=0;
          }
        }
      }
      else if(v.phase==='toHosp'){
        const plPx=pathLen(v.hpath)*CW;
        v.pp+=plPx>0?(spd/plPx)*dt:0.002*dt;
        if(v.pp>=1){
          const st=STATION_DEFS[v.type];
          v.rpath=pathfind(v.hospNid,st.nid);
          v.phase='returning';v.pp=0;
        }
      }
      else if(v.phase==='returning'){
        const plPx=pathLen(v.rpath)*CW;
        v.pp+=plPx>0?(spd/plPx)*dt:0.002*dt;
        if(v.pp>=1){v.done=true;G.veh[v.type].busy=Math.max(0,G.veh[v.type].busy-1);updateCards();}
      }
    }
  });
  G.vehs=G.vehs.filter(v=>!v.done);

  // Timeouts
  G.ems.forEach(e=>{
    if(!e.timedOut&&!e.resolved){
      const tMax=Math.max(16000,34000-G.wave*1200);
      if(t-e.born>tMax&&!e.fullyDisp){
        e.timedOut=true;G.rating=Math.max(0,G.rating-1);updateUI();sfxTimeout();
        if(G.rating<=0)triggerGameOver();
      }
    }
  });
  G.ems=G.ems.filter(e=>!e.timedOut&&!e.resolved);

  updateTicker();
  requestAnimationFrame(loop);
}

function checkResolved(eid){
  const em=G.ems.find(e=>e.id===eid);if(!em)return;
  const nFilled=em.needs.every(n=>em.disp.filter(d=>d.type===n).length>=em.needs.filter(x=>x===n).length);
  const allDone=em.disp.every(d=>d.done);
  if(nFilled&&allDone){
    em.resolved=true;G.money+=em.rw;G.score+=em.rw;G.resolved++;
    G.rating=Math.min(5,G.rating+0.35);
    updateUI();sfxResolve();
    // Clear the status panel if it was showing this incident
    if(selEm&&selEm.id===eid) clearStatus();
  }
}

function dispatch(type,eid){
  const avail=G.veh[type].total-G.veh[type].busy;
  if(avail<=0)return false;
  const em=G.ems.find(e=>e.id===eid);if(!em)return false;
  const needed=em.needs.filter(n=>n===type).length;
  const sent=em.disp.filter(d=>d.type===type).length;
  if(sent>=needed)return false;

  G.veh[type].busy++;updateCards();
  const st=STATION_DEFS[type];
  const path=pathfind(st.nid,nearestNode(em.x,em.y));
  const wd=(2000+Math.random()*3000)/G.efficiency;

  em.disp.push({type,inProg:false,progress:0,done:false});
  // For helicopter: store straight-line start coords (station position)
  const sx=st.x, sy=st.y;
  G.vehs.push({type,phase:'going',path,rpath:null,hpath:null,hospNid:null,pp:0,eid,ex:em.x,ey:em.y,sx,sy,wd,ws:0});

  if(em.needs.every(n=>em.disp.filter(d=>d.type===n).length>=em.needs.filter(x=>x===n).length))
    em.fullyDisp=true;

  sfxDispatch();refreshStatus();
  return true;
}

/* â”€â”€â”€ UI â”€â”€â”€ */
function updateCards(){
  ['police','fire','amb','heli'].forEach(type=>{
    const v=G.veh[type],avail=v.total-v.busy;
    document.getElementById('cn-'+type).textContent=avail;
    const card=document.getElementById('uc-'+type),st=document.getElementById('st-'+type);
    if(avail<=0){card.classList.add('busy');st.className='us on';st.textContent='ON CALL';}
    else{card.classList.remove('busy');st.className='us ok';st.textContent=avail+' READY';}
  });
}
function updateUI(){
  document.getElementById('sc-el').textContent=G.score;
  document.getElementById('mo-el').textContent='$'+G.money;
  document.getElementById('wa-el').textContent=G.wave;
  document.getElementById('ra-el').textContent=faceForRating(G.rating);
  document.getElementById('re-el').textContent=G.resolved;
}
function updateTicker(){
  const el=document.getElementById('t-inner');
  if(!G.ems.length){el.innerHTML='<span style="color:#1a3a55">Monitoring city systems â€” all clear</span>';return;}
  el.innerHTML=G.ems.map(e=>{
    const et=ET.find(x=>x.n===e.type),col=UCOLS[et.cl];
    const rem=e.needs.filter(n=>e.disp.filter(d=>d.type===n).length<e.needs.filter(x=>x===n).length);
    return `<span class="ti"><span class="td" style="background:${col}"></span><span style="color:${col}">${e.type}</span><span style="color:#1e4060"> â€” ${e.loc}</span>${rem.length?`<span style="color:#ff4444;font-size:8px"> [NEEDS:${rem.join(',')}]</span>`:'<span style="color:#00ff88;font-size:8px"> [OK]</span>'}</span>`;
  }).join('');
}

/* â”€â”€â”€ STATUS PANEL â”€â”€â”€ */
let selEm=null;
const spIdle=document.getElementById('sp-idle');
const spActive=document.getElementById('sp-active');
function showStatus(em){
  selEm=em;spIdle.classList.add('hidden');spActive.classList.add('on');
  document.getElementById('sp-title').textContent='ğŸš¨ '+em.type;
  document.getElementById('sp-sev').textContent=em.sv+' SEVERITY';
  document.getElementById('sp-loc').textContent='ğŸ“ '+em.loc;
  document.getElementById('sp-desc').textContent=em.desc||'';
  const tally={};em.needs.forEach(n=>tally[n]=(tally[n]||0)+1);
  const sent={};em.disp.forEach(d=>sent[d.type]=(sent[d.type]||0)+1);
  document.getElementById('sp-needs').innerHTML=Object.entries(tally).map(([t2,c])=>{
    const s=sent[t2]||0,done=s>=c?' done':'';
    return `<span class="np ${t2}${done}">${UICONS[t2]||'?'} ${c>1?t2.toUpperCase()+' Ã—'+c:t2.toUpperCase()}${done?' âœ“':''}</span>`;
  }).join('');
}
function refreshStatus(){if(selEm){const fr=G.ems.find(e=>e.id===selEm.id);fr?showStatus(fr):clearStatus();}}
function clearStatus(){selEm=null;spIdle.classList.remove('hidden');spActive.classList.remove('on');}
document.getElementById('sp-close').addEventListener('click',clearStatus);

canvas.addEventListener('click',e=>{
  const r=canvas.getBoundingClientRect(),cx=e.clientX-r.left,cy=e.clientY-r.top;
  const hit=G.ems.find(em=>Math.hypot(cx-mx(em.x),cy-my(em.y))<22);
  hit?showStatus(hit):clearStatus();
});
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const t2=e.touches[0],r=canvas.getBoundingClientRect();
  const hit=G.ems.find(em=>Math.hypot(t2.clientX-r.left-mx(em.x),t2.clientY-r.top-my(em.y))<26);
  hit?showStatus(hit):clearStatus();
},{passive:false});

/* â”€â”€â”€ DRAG & DROP â”€â”€â”€ */
let dragType=null;
const ghost=document.getElementById('ghost');
['police','fire','amb','heli'].forEach(type=>{
  const card=document.getElementById('uc-'+type);
  card.addEventListener('mousedown',e=>{if(card.classList.contains('busy'))return;e.preventDefault();startDrag(type,e.clientX,e.clientY);});
  card.addEventListener('touchstart',e=>{if(card.classList.contains('busy'))return;e.preventDefault();startDrag(type,e.touches[0].clientX,e.touches[0].clientY);},{passive:false});
});
function startDrag(t,x,y){ensureAC();dragType=t;ghost.textContent=UICONS[t];ghost.style.color=UCOLS[t];ghost.style.display='block';moveDrag(x,y);}
function moveDrag(x,y){ghost.style.left=x+'px';ghost.style.top=y+'px';}
function endDrag(x,y){
  ghost.style.display='none';if(!dragType)return;
  const r=canvas.getBoundingClientRect();
  const hit=G.ems.find(em=>Math.hypot(x-r.left-mx(em.x),y-r.top-my(em.y))<32);
  if(hit)dispatch(dragType,hit.id);
  else if(selEm)dispatch(dragType,selEm.id);
  dragType=null;
}
document.addEventListener('mousemove',e=>{if(dragType)moveDrag(e.clientX,e.clientY);});
document.addEventListener('mouseup',e=>{if(dragType)endDrag(e.clientX,e.clientY);});
document.addEventListener('touchmove',e=>{if(dragType){e.preventDefault();moveDrag(e.touches[0].clientX,e.touches[0].clientY);}},{passive:false});
document.addEventListener('touchend',e=>{if(dragType){const t2=e.changedTouches[0];endDrag(t2.clientX,t2.clientY);}});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  UPGRADES  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRICING RATIONALE:
   Average call reward â‰ˆ $210 (single-unit, wave 1-2)
   Target first upgrades reachable after ~4-6 calls (wave 2): $700-900
   Mid-tier after ~10-15 calls (wave 4-5): $1400-1800
   Late-tier after ~25-35 calls (wave 7+): $2600-3500
*/
const UPGS=[
  // â”€â”€ TIER 1: Early â€” target wave 2-3 (~$700-900) â”€â”€
  {id:'xp1', icon:'ğŸš”',n:'2nd Police Car',    c:1400, d:'Add a 2nd patrol car to the fleet.',            type:'police',tier:1},
  {id:'xf1', icon:'ğŸš’',n:'2nd Fire Truck',    c:1500, d:'Add a 2nd fire truck to the fleet.',            type:'fire',  tier:1},
  {id:'xa1', icon:'ğŸš‘',n:'2nd Ambulance',     c:1400, d:'Add a 2nd ambulance to the fleet.',             type:'amb',   tier:1},
  {id:'eff1',icon:'âš¡',n:'Pro Training',      c:900,  d:'Crews resolve incidents 25% faster.',           eff:1.25,     tier:1},
  // â”€â”€ TIER 2: Mid â€” target wave 4-5 (~$1400-1800) â”€â”€
  {id:'xh1', icon:'ğŸš',n:'2nd Helicopter',    c:3000, d:'Add a 2nd helicopter to the heliport.',         type:'heli',  tier:2},
  {id:'xp2', icon:'ğŸš”',n:'3rd Police Car',    c:2800, d:'Add a 3rd patrol car to the fleet.',            type:'police',tier:2},
  {id:'xf2', icon:'ğŸš’',n:'3rd Fire Truck',    c:3000, d:'Add a 3rd fire truck to the fleet.',            type:'fire',  tier:2},
  {id:'xa2', icon:'ğŸš‘',n:'3rd Ambulance',     c:2800, d:'Add a 3rd ambulance to the fleet.',             type:'amb',   tier:2},
  {id:'eff2',icon:'âš¡',n:'Elite Response',    c:1800, d:'Crews resolve 50% faster (stacks with Training).', eff:1.5, tier:2},
  // â”€â”€ TIER 3: Late â€” target wave 7+ (~$2600-3500) â”€â”€
  {id:'xp3', icon:'ğŸš”',n:'4th Police Car',    c:5200, d:'Add a 4th patrol car.',                         type:'police',tier:3},
  {id:'xf3', icon:'ğŸš’',n:'4th Fire Truck',    c:5600, d:'Add a 4th fire truck.',                         type:'fire',  tier:3},
  {id:'xa3', icon:'ğŸš‘',n:'4th Ambulance',     c:5200, d:'Add a 4th ambulance.',                          type:'amb',   tier:3},
  {id:'xh2', icon:'ğŸš',n:'3rd Helicopter',    c:6400, d:'Add a 3rd helicopter.',                         type:'heli',  tier:3},
  {id:'eff3',icon:'âš¡',n:'Tactical Command',  c:3500, d:'30% faster crews + 2 extra incident slots.',    eff:1.3,bonus:'cap',tier:3},
];

const TIER_INFO=[
  {label:'EARLY GAME',col:'#00ff88'},
  {label:'MID GAME',  col:'#00d4ff'},
  {label:'LATE GAME', col:'#ff3399'},
];

document.getElementById('upg-btn').addEventListener('click',showUpgrades);
document.getElementById('um-close').addEventListener('click',()=>document.getElementById('um').classList.remove('on'));

function showUpgrades(){
  const ul=document.getElementById('ul2');
  let html='';
  [1,2,3].forEach(tier=>{
    const info=TIER_INFO[tier-1];
    html+=`<div class="tier-row" style="color:${info.col}">
      <span class="tier-label">${info.label}</span>
      <div class="tier-line"></div>
    </div>`;
    UPGS.filter(u=>u.tier===tier).forEach(u=>{
      const bought=G.upgrades.has(u.id);
      const afford=G.money>=u.c;
      let cls='utile';
      if(bought)cls+=' bought';
      else if(!afford)cls+=' cant-afford';
      html+=`<div class="${cls}" data-id="${u.id}" title="${u.d}">
        ${bought?'<span class="utile-check">âœ“</span>':''}
        <div class="utile-icon">${u.icon}</div>
        <div class="utile-name">${u.n}</div>
        <div class="utile-price${bought?' owned':!afford?' cant':''}">
          ${bought?'OWNED':'$'+u.c.toLocaleString()}
        </div>
      </div>`;
    });
  });
  ul.innerHTML=html;

  ul.querySelectorAll('.utile:not(.bought)').forEach(el=>{
    el.addEventListener('click',()=>{
      const u=UPGS.find(x=>x.id===el.dataset.id);
      if(!u||G.upgrades.has(u.id)||G.money<u.c)return;
      G.money-=u.c;G.upgrades.add(u.id);
      if(u.type)G.veh[u.type].total++;
      if(u.eff)G.efficiency*=u.eff;
      if(u.bonus==='cap')G.capBonus=(G.capBonus||0)+2;
      updateCards();updateUI();sfxResolve();showUpgrades();
    });
  });
  document.getElementById('um').classList.add('on');
}


/* â”€â”€ GAME OVER â”€â”€ */
function triggerGameOver(){
  G.gameOver=true;
  document.getElementById('go-score').textContent=G.score.toLocaleString();
  document.getElementById('go-res').textContent=G.resolved;
  document.getElementById('go-wave').textContent=G.wave;
  document.getElementById('go-screen').classList.add('on');
  sfxTimeout();sfxTimeout();
}

document.getElementById('go-btn').addEventListener('click',()=>{
  // Reset all state
  Object.assign(G,{
    money:0,score:0,resolved:0,rating:5,wave:1,capBonus:0,
    ems:[],vehs:[],nextId:1,spawnT:12000,waveT:0,lastT:0,
    veh:{police:{total:1,busy:0},fire:{total:1,busy:0},amb:{total:1,busy:0},heli:{total:1,busy:0}},
    efficiency:1.0,upgrades:new Set(),gameOver:false,
  });
  lastSpawnCl=null;spawnsSinceHeli=0;selEm=null;
  clearStatus();updateCards();updateUI();
  document.getElementById('go-screen').classList.remove('on');
  mapCanvas=null;
  requestAnimationFrame(t=>{
    G.lastT=t;
    buildMapCanvas();spawnEm();
    requestAnimationFrame(loop);
  });
});

/* â”€â”€â”€ TITLE GRID LINES â”€â”€â”€ */
const tbg=document.getElementById('title-bg');
for(let i=0;i<14;i++){
  const l=document.createElement('div');l.className='tgl';
  if(i<7)l.style.cssText=`left:${i*16}%;top:0;width:1px;height:100%;`;
  else l.style.cssText=`top:${(i-7)*16}%;left:0;width:100%;height:1px;`;
  tbg.appendChild(l);
}

/* â”€â”€â”€ START â”€â”€â”€ */
document.getElementById('start-btn').addEventListener('click',()=>{
  ensureAC();
  document.getElementById('title').style.display='none';
  document.getElementById('game').classList.add('on');
  resize();mapCanvas=null;
  requestAnimationFrame(t=>{
    G.lastT=t;G.spawnT=12000;G.waveT=0;
    buildMapCanvas();spawnEm();
    requestAnimationFrame(loop);
  });
});
</script>
</body>
</html>
